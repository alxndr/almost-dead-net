{"version":3,"sources":["webpack://almost-dead-net/./src/helpers/string_helpers.js","webpack://almost-dead-net/./src/pages/fan-stats.js"],"names":["pluralize","number","word","numericalSort","a","b","UsernameForm","action","type","name","placeholder","size","LinkedUser","username","href","PageTitle","venueURL","id","slugify","uniqBySongId","uniqBy","song_id","FanStats","user","shows","songs","teases","showIDs","Object","keys","venues","uniq","values","map","venue","uniqSongs","uniqTeases","length","sort","showID","date","key","to","location","song_name","tease","FanStatsPage","data","usernameRaw","URLSearchParams","search","get","useState","userJson","setUserJson","showsData","setShowsData","perfsData","setPerfsData","teasesData","setTeasesData","useEffect","fetch","then","response","json","user_fields","JSON","parse","allSets","allSetsCsv","nodes","allSongPerfs","allSongperformancesCsv","allTeases","allTeasesCsv","allShows","allShowsCsv","allVenues","allVenuesCsv","findSongPerf","find","__","findSet","findShow","findVenue","filterTeases","filter","reduce","showDateString","showDMYYYY","split","replace","showData","propEq","venue_id","setIDs","show","concat","set1","set2","set3","encore1","encore2","Boolean","setID","flatMap","setlist","String","songPerfID","perf","className","title","error"],"mappings":"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","file":"component---src-pages-fan-stats-js-ed7f5e49d3fa3662aa90.js","sourcesContent":["/* Appends an \"s\" to the end of `word` if warranted by the value of `number` */\nexport function pluralize(number, word) {\n  return `${number} ${word}${number !== 1 ? 's' : ''}`\n}\n","import React, {useEffect, useState} from 'react'\nimport {graphql, Link} from 'gatsby'\nimport {filter, find, propEq, sort, uniq, uniqBy, __} from 'ramda'\nimport slugify from 'slugify'\n\nimport Layout from '../components/layout'\nimport SEO from '../components/seo'\n\nimport {pluralize} from '../helpers/string_helpers'\n\nimport './fan-stats.css'\n\nconst numericalSort = (a, b) => a - b\n\nconst UsernameForm = () => <form action=\"/fan-stats\">\n  <input type=\"text\" name=\"username\" placeholder=\"your username on The Lot\" size=\"30\" />\n  <button>generate stats</button>\n</form>\n\nconst LinkedUser = ({username}) => <a href={`https://lot.almost-dead.net/u/${username}/summary`}>@{username}</a>\n\nconst PageTitle = ({username}) => {\n  if (username) {\n    return <><LinkedUser username={username} />'s Fan Stats</>\n  }\n  return 'Fan Stats'\n}\n\nconst venueURL = ({id, name}) => `/venue/${id}-${slugify(name)}`\n\nconst extractSongId = ({song_id}) => song_id\nconst uniqBySongId = uniqBy(extractSongId)\n\nconst FanStats = ({user, shows, songs, teases}) => {\n  const showIDs = Object.keys(shows)\n  // const songIDs = Object.keys(songs)\n  const venues = uniq(Object.values(shows).map(({venue}) => venue))\n  const uniqSongs = uniqBySongId(songs)\n  const uniqTeases = uniqBySongId(teases)\n\n  return <>\n    <p><LinkedUser username={user.username} /> was at {pluralize(showIDs.length, 'show')} across {pluralize(venues.length, 'venue')}, with {pluralize(uniqSongs.length, 'different song')} performed, and {pluralize(uniqTeases.length, 'unique song')} teased!</p>\n\n    <h2>Shows</h2>\n    <ol>\n      {sort(numericalSort, showIDs).map((showID) => {\n        const {date, venue} = shows[showID]\n        return <li key={showID}>\n          <Link to={`/show/${showID}`}>{date}</Link>\n          {' at '}\n          <Link to={venueURL(venue)}>{venue.name}, {venue.location}</Link>\n        </li>\n      })}\n    </ol>\n\n    <h2>Venues</h2>\n    <ol>\n      {venues.map((venue) => <li key={venue.id}><Link to={venueURL(venue)}>{venue.name}, {venue.location}</Link></li>)}\n    </ol>\n\n    <h2>Songs</h2>\n    <ol>\n      {uniqSongs.map(({song_id, song_name}) => <li key={song_id}><Link to={`/song/${song_id}`}>{song_name}</Link></li>)}\n    </ol>\n\n    <h2>Teases</h2>\n    <ol>\n      {uniqTeases.map((tease) => <li key={tease.song_id}><Link to={`/song/${tease.song_id}`}>{tease.song_name}</Link></li>)}\n    </ol>\n  </>\n}\n\nexport default function FanStatsPage({location, data}) {\n  const usernameRaw = new URLSearchParams(location.search).get('username')\n  const [userJson, setUserJson] = useState()\n  const [showsData, setShowsData] = useState({})\n  const [perfsData, setPerfsData] = useState()\n  const [teasesData, setTeasesData] = useState()\n\n  useEffect(() => {\n    if (usernameRaw) {\n      fetch(`https://lot.almost-dead.net/u/${usernameRaw}.json`)\n        .then((response) => response.json())\n        .then((json) => {\n          if (json?.user) {\n            setUserJson({\n              user: json.user,\n              shows: json.user.user_fields[1]\n                ? JSON.parse(json.user.user_fields[1]) // TODO This will throw if the field is invalid JSON (which happens...)\n                : [],\n            })\n          }\n        })\n    }\n  }, [usernameRaw])\n\n  const {\n    allSetsCsv: {nodes: allSets},\n    allSongperformancesCsv: {nodes: allSongPerfs},\n    allTeasesCsv: {nodes: allTeases},\n    allShowsCsv: {nodes: allShows},\n    allVenuesCsv: {nodes: allVenues},\n  } = data\n  const findSongPerf = find(__, allSongPerfs)\n  const findSet = find(__, allSets)\n  const findShow = find(__, allShows)\n  const findVenue = find(__, allVenues)\n  const filterTeases = filter(__, allTeases)\n\n  useEffect(() => {\n    if (userJson?.shows) {\n      const shows = userJson.shows.reduce((showsData, showDateString) => {\n        const showDMYYYY = showDateString.split(' ')[0].replace(/\\/(\\d{2})$/, '/20$1')\n        const showData = findShow(propEq('date', showDMYYYY))\n        if (showData?.id) {\n          const venue = findVenue(propEq('id', showData.venue_id))\n          return {\n            ...showsData,\n            [showData.id]: {\n              ...showData,\n              venue,\n            },\n          }\n        }\n        return showsData\n      }, {})\n      setShowsData(shows)\n\n      const perfsData = Object.values(shows)\n        .reduce((setIDs, show) => setIDs.concat([show.set1, show.set2, show.set3, show.encore1, show.encore2].filter((id) => Boolean(id))), [])\n        // now it is an array of set ID strings...\n        .map((setID) => findSet(propEq('id', setID)))\n        .flatMap(({setlist}) => String(setlist).split(':'))\n        // now it is an array of songperf ID strings\n        .map((songPerfID) => findSongPerf(propEq('id', songPerfID)))\n        // now it is an array of songperf objs\n      setPerfsData(perfsData)\n\n      const teasesData = perfsData\n        .flatMap((perf) => filterTeases(propEq('performance_id', perf.id)))\n      setTeasesData(teasesData)\n    }\n  }, [userJson])\n\n  return <Layout className=\"fanstatspage\">\n    <SEO title=\"JRAD Fan Stats\" />\n    <h1><PageTitle username={userJson?.user?.username} /></h1>\n    {usernameRaw\n      ? userJson?.user\n        ? Object.keys(showsData).length\n          ? <FanStats shows={showsData} songs={perfsData} teases={teasesData} user={userJson.user} />\n          : <><p>No shows found! (Have you entered them in <a href=\"https://lot.almost-dead.net/my/preferences/profile\">your account preferences on The Lot</a>?)</p><UsernameForm/></>\n        : userJson?.error\n          ? <><p>Uh oh, error fetching data.</p><UsernameForm/></>\n          : <p>Loading...</p>\n      : <UsernameForm/>\n    }\n  </Layout>\n}\n\nexport const query = graphql`\n  query FanStatsData {\n    allVenuesCsv {\n      nodes {\n        id\n        name\n        location\n        capacity\n        generic_name\n        tagname\n      }\n    }\n    allShowsCsv {\n      nodes {\n        date\n        encore1\n        encore2\n        event\n        id\n        links\n        notes\n        num_recordings\n        set1\n        set2\n        set3\n        soundcheck\n        tagline\n        venue_id\n      }\n    }\n    allSetsCsv {\n      nodes {\n        id\n        setlist\n      }\n    }\n    allSongperformancesCsv {\n      nodes {\n        id\n        set_id\n        song_id\n        song_name\n      }\n    }\n    allTeasesCsv {\n      nodes {\n        id\n        performance_id\n        song_id\n        song_name\n      }\n    }\n  }\n`\n"],"sourceRoot":""}